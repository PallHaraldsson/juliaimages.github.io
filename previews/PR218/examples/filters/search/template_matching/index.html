<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Template Matching · JuliaImages</title><script data-outdated-warner src="../../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../../assets/documenter.js"></script><script src="../../../../siteinfo.js"></script><script src="../../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../../assets/themeswap.js"></script><link href="../../../../democards/gridtheme.css" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../../"><img src="../../../../assets/logo.png" alt="JuliaImages logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../../">JuliaImages</a></span></div><form class="docs-search" action="../../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../../">Home</a></li><li><a class="tocitem" href="../../../../install/">Getting started</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../../../tutorials/quickstart/">Quickstart</a></li><li><a class="tocitem" href="../../../../tutorials/arrays_colors/">Arrays, Numbers, and Colors</a></li><li><a class="tocitem" href="../../../../tutorials/conversions_views/">Conversions vs. views</a></li><li><a class="tocitem" href="../../../../tutorials/indexing/">Arrays: more advanced indexing</a></li></ul></li><li><span class="tocitem">Packages</span><ul><li><a class="tocitem" href="../../../../pkgs/">Introduction</a></li><li><a class="tocitem" href="../../../../pkgs/axes/">ImageAxes.jl</a></li><li><a class="tocitem" href="../../../../pkgs/metadata/">ImageMetaData.jl</a></li><li><a class="tocitem" href="../../../../pkgs/segmentation/">ImageSegmentation.jl</a></li><li><a class="tocitem" href="../../../../pkgs/transformations/">ImageTransformations.jl</a></li><li><a class="tocitem" href="../../../../pkgs/features/">ImageFeatures.jl</a></li></ul></li><li><a class="tocitem" href="../../../">Demos</a></li><li><a class="tocitem" href="../../../../function_reference/">References</a></li><li><a class="tocitem" href="../../../../api_comparison/">Comparison with other image processing frameworks</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Template Matching</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Template Matching</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaImages/juliaimages.github.io/blob/source/docs/src/examples/filters/search/template_matching.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Template-Matching"><a class="docs-heading-anchor" href="#Template-Matching">Template Matching</a><a id="Template-Matching-1"></a><a class="docs-heading-anchor-permalink" href="#Template-Matching" title="Permalink"></a></h1><p><a href="../template_matching.jl"><img src="https://img.shields.io/badge/download-julia-brightgreen.svg" alt="Source code"/></a> <a href="https://nbviewer.jupyter.org/github/JuliaImages/juliaimages.github.io/blob/master/previews/PR218/examples/filters/search/template_matching.ipynb"><img src="https://img.shields.io/badge/show-nbviewer-579ACA.svg" alt="notebook"/></a> <img src="https://img.shields.io/badge/Author-Michael%20Pusterhofer-blue" alt="Author"/> <img src="https://img.shields.io/date/1624320000" alt="Update time"/></p><p>This demo shows how to find objects in an image using template matching.</p><p>The main idea is to check the similarity between a search target(template) and a subsection of the image. The subsection is usually the same size as the template. Therefore by using <a href="../../../../function_reference/#ImageFiltering.MapWindow.mapwindow"><code>mapwindow</code></a> we can assign a value for every subsection of the image.</p><p>At first we import the following packages.</p><pre><code class="language- hljs">using ImageCore: Gray
using ImageMorphology: label_components, component_centroids
using ImageFiltering: mapwindow, Fill, imfilter, KernelFactors
using ImageDistances: sqeuclidean
using ImageContrastAdjustment: adjust_histogram, LinearStretching
using TestImages
using Plots: scatter!, plot</code></pre><p><code>ImageCore</code> enables the generation of images, <code>ImageFiltering</code> provides the <a href="../../../../function_reference/#ImageFiltering.MapWindow.mapwindow"><code>mapwindow</code></a> function and <code>ImageFeatures</code> provides functions to label segments of an image. To calculate the similarity <code>squeclidean</code> is used. This defines a distance between two images as:</p><p class="math-container">\[\textrm{distance} = \sum_i^{\textrm{number of pixels}} (\textrm{template}_i - \textrm{subsection}_i)^2\]</p><p><code>ImageContrastAdjustment</code> provides functions to adjust the histogram, which is useful when an image contains values bigger than 1 or smaller than 0.  The <code>Testimages</code> package will provide our image and plot is used to overlay a scatter plot onto the image.</p><p>To start we first load our image.</p><pre><code class="language- hljs">img = testimage(&quot;moonsurface&quot;)</code></pre><p>Let&#39;s say we want to find the medium sized craters in the image based one of the impact areas. For this we generate a template from a subsection of the image and apply a small gaussian blur using <a href="../../../../function_reference/#ImageFiltering.imfilter"><code>imfilter</code></a>. The gaussian blur often helps when the search targets are not exactly the same.</p><pre><code class="language- hljs">template = img[12:22,20:30]
template = imfilter(template,KernelFactors.gaussian((0.5,0.5)))</code></pre><p>Now that we have an image and a template, the next step is to define how we measure the similarity between a section of the image and the template. This can be done in multiple way, but a sum of square distances should work quite well. The <code>ImageDistance</code> package provides an already optimized version called <code>sqeuclidean</code>, which can be used to define a function for <a href="../../../../function_reference/#ImageFiltering.MapWindow.mapwindow"><code>mapwindow</code></a>.  Let&#39;s call it <code>SDIFF</code>.</p><pre><code class="language-julia hljs">function SDIFF(template)
  (subsection)-&gt;sqeuclidean(subsection, template)
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">SDIFF (generic function with 1 method)</code></pre><p>To actually generate our similarity map we use <a href="../../../../function_reference/#ImageFiltering.MapWindow.mapwindow"><code>mapwindow</code></a> in the following way.</p><pre><code class="language- hljs">res = mapwindow(SDIFF(template), img, size(template), border=Fill(1)) .|&gt; Gray
rescaled_map = adjust_histogram(res, LinearStretching())</code></pre><p>If the subsection is located at the border of the image the image has to be extended and in our case we will fill all values outside the image with 1. One thing to keep in mind is that because all of the square differences will be summed up per subsection the resulting sum can be bigger than 1. This will be a problem if we just convert it to an image to check the values. To rescale the values to be between 0 and 1 we can use <code>adjust_histogram</code>.</p><p>To find the best locations we have to look for small values on the similarity map. This can be done by comparing if the pixel is below a certain value. Let&#39;s chose a value of <code>0.05</code>.</p><pre><code class="language- hljs">threshold = rescaled_map .&lt; 0.05
Gray.(threshold)</code></pre><p>Now we see small blobs at the locations which match our template and we can label the connected regions by <code>label_components</code>.  This will enumerate are connected regions and <code>component_centroids</code> can be used to get the centroid of each region.  <code>component_centroids</code> also return the centroid for the background region, which is at the first position and we will omit it.</p><pre><code class="language- hljs">centroids = component_centroids(label_components(threshold))[2:end]</code></pre><p>To check if it worked correctly we can overlay the centroids with the original image using the <code>Plots</code> package. As the images are stored using the first index for rows we have to reverse the order of the coordinates to match the order of the plotting library.</p><pre><code class="language- hljs">plot(Gray.(img), size=(512,512))
scatter!(reverse.(centroids), label=&quot;centroids&quot;, ms=10, alpha=0.5, c=:red, msw=3)</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/johnnychen94/DemoCards.jl">DemoCards.jl</a> and <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.5 on <span class="colophon-date" title="Monday 16 August 2021 09:55">Monday 16 August 2021</span>. Using Julia version 1.6.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
